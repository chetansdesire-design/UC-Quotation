<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Urban Casa | Quotation</title>
    <style>
        :root {
            --primary: #1a252f;
            --accent: #34495e;
            --btn-green: #27ae60;
            --btn-blue: #2980b9;
            --btn-orange: #f39c12;
            --btn-purple: #8e44ad;
            --savings: #27ae60;
            --danger: #e74c3c;
            --bg-light: #f8f9fa;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f0f2f5;
            color: #333;
        }

        .container {
            max-width: 1100px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            position: relative;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-left { display: flex; align-items: center; gap: 15px; }
        .logo { height: 50px; width: auto; }
        
        .brand-content h1 { margin: 0; font-size: 20px; letter-spacing: 2px; text-transform: uppercase; color: var(--primary); }
        .tagline { margin: 2px 0; font-size: 9px; color: #7f8c8d; font-style: italic; }
        .address-info { font-size: 10px; margin-top: 5px; color: #444; line-height: 1.4; }

        .quote-header-label {
            background-color: var(--primary);
            color: white;
            padding: 6px 15px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            border-radius: 4px;
        }

        .client-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .info-group {
            display: flex;
            flex-direction: column;
            border: 1px solid #dcdde1;
            border-radius: 4px;
            overflow: hidden;
        }

        .info-label {
            background-color: var(--primary);
            color: white;
            padding: 5px 10px;
            font-weight: bold;
            font-size: 9px;
            text-transform: uppercase;
        }

        .info-group input { border: none; padding: 10px; font-size: 12px; width: 100%; outline: none; background: white; box-sizing: border-box; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: var(--primary); color: white; padding: 12px 8px; font-size: 10px; text-transform: uppercase; }
        td { border: 1px solid #efefef; padding: 10px 5px; text-align: center; font-size: 12px; }

        .image-box { 
            width: 70px; height: 70px; border: 1px dashed #ccc; border-radius: 4px;
            margin: auto; display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; background: #fafafa; position: relative; overflow: hidden;
        }
        .image-box img { width: 100%; height: 100%; object-fit: contain; position: absolute; top: 0; left: 0; }
        .upload-icon { font-size: 18px; color: #7f8c8d; z-index: 1; }
        .upload-text { font-size: 7px; font-weight: bold; color: #999; text-transform: uppercase; z-index: 1; }
        input[type="file"] { display: none; }

        .table-input { width: 95%; border: 1px solid #eee; padding: 8px 5px; text-align: center; font-size: 12px; outline: none; border-radius: 3px; font-family: inherit; }

        .btn-container { padding: 15px 0; display: flex; flex-wrap: wrap; gap: 10px; }
        .btn { border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 11px; text-transform: uppercase; padding: 14px 18px; color: white; flex: 1; min-width: 140px; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-add { background: var(--btn-green); }
        .btn-print { background: var(--btn-blue); }
        .btn-save { background: var(--btn-orange); }
        .btn-search { background: var(--btn-purple); }
        
        .btn-del { 
            background: none; 
            border: none; 
            cursor: pointer; 
            color: #95a5a6; 
            font-size: 18px; 
            padding: 5px;
            transition: color 0.2s;
        }
        .btn-del:hover { color: var(--danger); }

        .footer-area {
            margin-top: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .remarks-box textarea { width: 100%; border: 1px solid #dcdde1; border-radius: 4px; padding: 10px; font-size: 11px; resize: none; min-height: 80px; font-family: inherit; box-sizing: border-box; }

        .totals-box { border: 2px solid var(--primary); border-radius: 6px; overflow: hidden; background: white; }
        .total-line { display: flex; justify-content: space-between; padding: 10px 15px; border-bottom: 1px solid #eee; font-size: 13px; }
        .savings-highlight { background-color: #ebfbee; color: var(--savings); font-weight: bold; }
        .grand-total { background: var(--primary); color: white; font-size: 15px; border-bottom: none; font-weight: bold; }

        .terms-section { margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; }

        .signature-container {
            margin-top: 50px;
            display: flex;
            justify-content: flex-end;
            padding-right: 50px;
        }
        .signature-box { text-align: center; width: 250px; }
        .sig-line { border-top: 1px solid #333; width: 100%; margin-bottom: 8px; }
        .sig-text { font-size: 11px; font-weight: bold; text-transform: uppercase; color: var(--primary); }

        #searchModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 1001;
            width: 350px;
        }
        #modalOverlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
        }
        .modal-select { width: 100%; padding: 12px; margin: 15px 0; border: 1px solid #ccc; border-radius: 4px; font-family: inherit; }

        @media screen and (max-width: 768px) {
            .client-info { grid-template-columns: 1fr; }
            thead { display: none; }
            table, tbody, tr, td { display: block; width: 100%; }
            tr { margin-bottom: 15px; border: 1px solid var(--primary); border-radius: 8px; padding: 10px; box-sizing: border-box; background: #fff; }
            td { text-align: left; padding: 8px 0; border: none; border-bottom: 1px solid #f0f0f0; position: relative; padding-left: 40%; }
            td::before { content: attr(data-label); position: absolute; left: 10px; width: 35%; font-weight: bold; font-size: 10px; text-transform: uppercase; color: var(--primary); }
            .table-input { text-align: left; width: 100%; }
            .signature-container { justify-content: center; padding-right: 0; }
        }

        @media print {
            .btn-container, .btn-del, .upload-icon, .upload-text, input[type="file"], #modalOverlay, #searchModal { display: none !important; }
            body { padding: 0; background: white; }
            .container { box-shadow: none; border: none; max-width: 100%; padding: 10px; }
            table { display: table !important; }
            thead { display: table-header-group !important; }
            tr { display: table-row !important; border: none !important; }
            td { display: table-cell !important; border: 1px solid #efefef !important; padding-left: 5px !important; text-align: center !important; }
            td::before { display: none !important; }
            .signature-container { margin-top: 80px; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="header-left">
            <img src="https://drive.google.com/thumbnail?id=1fFh9lGXoSzVHqInw5To3aB5lFb3xD_2N&sz=w500" alt="Urban Casa Logo" class="logo">
            <div class="brand-content">
                <h1>Urban Casa</h1>
                <p class="tagline">Timeless furniture for modern living</p>
                <div class="address-info">Raichandani Mall, Kompally, Hyderabad | +91 888 66 88 990</div>
            </div>
        </div>
        <div class="quote-header-label">Quotation</div>
    </header>

    <div class="client-info">
        <div class="info-group">
            <label class="info-label">Customer Name</label>
            <input type="text" id="custName" placeholder="Full Name" oninput="toTitleCase(this)">
        </div>
        <div class="info-group">
            <label class="info-label">Contact Number</label>
            <input type="tel" id="custPhone" placeholder="+91">
        </div>
        <div class="info-group">
            <label class="info-label">Quotation Date</label>
            <input type="text" id="dateInput" readonly>
        </div>
        <div class="info-group">
            <label class="info-label">Sales Executive</label>
            <input type="text" id="salesExec" placeholder="Executive Name" oninput="toTitleCase(this)">
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th style="width: 30px;">#</th>
                <th style="width: 80px;">Reference</th>
                <th style="width: 100px;">Barcode</th>
                <th>Item Description</th>
                <th style="width: 50px;">Qty</th>
                <th>MRP (Unit)</th>
                <th>Offer Price</th>
                <th>Amount</th>
                <th style="width: 40px;" class="no-print"></th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <tr class="item-row">
                <td data-label="Item #">1</td>
                <td data-label="Reference">
                    <label class="image-box">
                        <span class="upload-icon">üì§</span>
                        <span class="upload-text">Upload</span>
                        <input type="file" accept="image/*" onchange="previewImg(this)">
                    </label>
                </td>
                <td data-label="Barcode"><input type="text" class="table-input barcode" placeholder="Code"></td>
                <td data-label="Description"><input type="text" class="table-input desc" placeholder="Details..." oninput="toTitleCase(this)"></td>
                <td data-label="Qty"><input type="number" class="table-input qty" value="1" min="1" oninput="runCalc(this)"></td>
                <td data-label="MRP"><input type="number" class="table-input mrp" value="0" oninput="runCalc(this)"></td>
                <td data-label="Offer Price"><input type="number" class="table-input price" value="0" oninput="runCalc(this)"></td>
                <td data-label="Total" class="row-total">0.00</td>
                <td class="no-print"><button class="btn-del" onclick="deleteRow(this)">üóëÔ∏è</button></td>
            </tr>
        </tbody>
    </table>

    <div class="btn-container">
        <button class="btn btn-add" onclick="addNewRow()">+ Add Item</button>
        <button class="btn btn-save" onclick="saveToFirebase()">üíæ Save Quote</button>
        <button class="btn btn-search" onclick="searchQuote()">üîç Search Quote</button>
        <button class="btn btn-print" onclick="autoSaveAndExport()">üñ®Ô∏è Export PDF</button>
    </div>

    <div class="footer-area">
        <div class="remarks-section">
            <h4 style="font-size: 12px; margin-bottom: 5px; text-transform: uppercase;">Remarks</h4>
            <div class="remarks-box">
                <textarea id="remarks" rows="5" placeholder="Add specific remarks..." oninput="toTitleCase(this)"></textarea>
            </div>
        </div>

        <div class="right-column">
            <div class="totals-box">
                <div class="total-line"><span>Total Units:</span><span id="finalQty">1</span></div>
                <div class="total-line"><span>Total MRP (Incl. GST):</span><span id="finalMRP">0.00</span></div>
                <div class="total-line savings-highlight"><span>Total Savings:</span><span id="finalSavings">0.00</span></div>
                <div class="total-line grand-total"><span>Grand Total (Incl. GST):</span><span id="finalAmt">0.00</span></div>
            </div>
        </div>
    </div>

    <div class="terms-section">
        <h2 style="color: var(--primary); text-transform: uppercase; font-size: 16px;">Terms and Conditions</h2>
        <div style="font-size: 11px; line-height: 1.6; color: #333; margin-top: 10px;">
            <p>1. **20% advance** to be paid to proceed. Balance 80% prior to dispatch.</p>
            <p>2. Quotation valid for **7 business days**.</p>
            <p>3. Prices are **inclusive of GST**.</p>
            <p>4. Delivery included within city limits (Ground floor).</p>
        </div>
    </div>

    <div class="signature-container">
        <div class="signature-box">
            <div class="sig-line"></div>
            <div class="sig-text">Authorized Store Manager</div>
        </div>
    </div>
</div>

<div id="modalOverlay" onclick="closeModal()"></div>
<div id="searchModal">
    <h4 style="margin:0 0 10px 0; color: var(--primary);">Multiple Quotes Found</h4>
    <p style="font-size: 11px; color: #666;">Select the record you want to load:</p>
    <select id="recordDropdown" class="modal-select"></select>
    <div style="display: flex; gap: 10px;">
        <button class="btn btn-save" style="flex: 2;" onclick="confirmSelection()">Load Record</button>
        <button class="btn btn-del" style="flex: 1; border-radius: 4px; height: auto; width: auto; background:#95a5a6; color:white;" onclick="closeModal()">Cancel</button>
    </div>
</div>

<script>
    const FIREBASE_URL = "https://furniture-quotation-default-rtdb.firebaseio.com/quotations.json";
    let searchResults = {}; 

    function toTitleCase(input) {
        input.value = input.value.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
    }

    window.onload = function() {
        const now = new Date();
        document.getElementById('dateInput').value = `${String(now.getDate()).padStart(2, '0')}-${String(now.getMonth() + 1).padStart(2, '0')}-${now.getFullYear()}`;
    }

    function previewImg(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            const container = input.parentElement;
            reader.onload = e => {
                container.querySelectorAll('.upload-icon, .upload-text, img').forEach(el => el.remove());
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'preview-image';
                container.prepend(img);
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function runCalc(el) {
        const row = el.closest('tr');
        const q = parseFloat(row.querySelector('.qty').value) || 0;
        const p = parseFloat(row.querySelector('.price').value) || 0;
        row.querySelector('.row-total').innerText = (q * p).toLocaleString('en-IN', {minimumFractionDigits: 2});
        updateGrandTotals();
    }

    function updateGrandTotals() {
        let tQ = 0, tA = 0, tMRP = 0;
        document.querySelectorAll('.item-row').forEach(row => {
            const q = parseFloat(row.querySelector('.qty').value) || 0;
            const m = parseFloat(row.querySelector('.mrp').value) || 0;
            const p = parseFloat(row.querySelector('.price').value) || 0;
            tQ += q; tMRP += (q * m); tA += (q * p);
        });
        document.getElementById('finalQty').innerText = tQ;
        document.getElementById('finalMRP').innerText = tMRP.toLocaleString('en-IN', {minimumFractionDigits: 2});
        document.getElementById('finalSavings').innerText = (tMRP - tA).toLocaleString('en-IN', {minimumFractionDigits: 2});
        document.getElementById('finalAmt').innerText = tA.toLocaleString('en-IN', {minimumFractionDigits: 2});
    }

    function addNewRow() {
        const tbody = document.getElementById('tableBody');
        const rowCount = document.querySelectorAll('.item-row').length + 1;
        const tr = document.createElement('tr');
        tr.className = 'item-row';
        tr.innerHTML = `
            <td data-label="Item #">${rowCount}</td>
            <td data-label="Reference"><label class="image-box"><span class="upload-icon">üì§</span><span class="upload-text">Upload</span><input type="file" accept="image/*" onchange="previewImg(this)"></label></td>
            <td data-label="Barcode"><input type="text" class="table-input barcode" placeholder="Code"></td>
            <td data-label="Description"><input type="text" class="table-input desc" placeholder="Details..." oninput="toTitleCase(this)"></td>
            <td data-label="Qty"><input type="number" class="table-input qty" value="1" min="1" oninput="runCalc(this)"></td>
            <td data-label="MRP"><input type="number" class="table-input mrp" value="0" oninput="runCalc(this)"></td>
            <td data-label="Offer Price"><input type="number" class="table-input price" value="0" oninput="runCalc(this)"></td>
            <td data-label="Total" class="row-total">0.00</td>
            <td class="no-print"><button class="btn-del" onclick="deleteRow(this)">üóëÔ∏è</button></td>`;
        tbody.appendChild(tr);
        return tr;
    }

    function deleteRow(btn) {
        if(document.querySelectorAll('.item-row').length > 1) {
            btn.closest('tr').remove();
            updateGrandTotals();
        }
    }

    // UPDATED: Function now returns a promise so export can wait for it
    async function saveToFirebase() {
        const items = [];
        const rows = document.querySelectorAll('.item-row');
        
        for (const row of rows) {
            let imgData = null;
            const img = row.querySelector('.preview-image');
            if (img) imgData = img.src;

            items.push({
                barcode: row.querySelector('.barcode').value,
                desc: row.querySelector('.desc').value,
                qty: row.querySelector('.qty').value,
                mrp: row.querySelector('.mrp').value,
                price: row.querySelector('.price').value,
                image: imgData 
            });
        }

        const data = {
            customer: document.getElementById('custName').value,
            phone: document.getElementById('custPhone').value,
            date: document.getElementById('dateInput').value,
            salesExec: document.getElementById('salesExec').value,
            total: document.getElementById('finalAmt').innerText,
            remarks: document.getElementById('remarks').value,
            items: items
        };

        try {
            const response = await fetch(FIREBASE_URL, {
                method: 'POST',
                body: JSON.stringify(data),
                headers: { 'Content-Type': 'application/json' }
            });
            if(response.ok) {
                console.log("Auto-save complete.");
                return true;
            }
        } catch (e) {
            alert("Error saving to database.");
            return false;
        }
    }

    // NEW: Function to automate Save then Export
    async function autoSaveAndExport() {
        const saveSuccess = await saveToFirebase();
        if (saveSuccess) {
            exportWithFileName();
        } else {
            const proceed = confirm("Database save failed. Do you want to export anyway?");
            if (proceed) exportWithFileName();
        }
    }

    async function searchQuote() {
        const query = prompt("Enter Customer Name or Phone Number:").toLowerCase().trim();
        if (!query) return;

        try {
            const response = await fetch(FIREBASE_URL);
            const data = await response.json();
            if (!data) { alert("No data in database."); return; }

            const matches = Object.keys(data).filter(key => {
                const entry = data[key];
                const nameMatch = entry.customer && entry.customer.toLowerCase().includes(query);
                const phoneMatch = entry.phone && entry.phone.toString() === query;
                return nameMatch || phoneMatch;
            });

            if (matches.length === 0) {
                alert("No records found.");
            } else if (matches.length === 1) {
                loadRecordIntoForm(data[matches[0]]);
            } else {
                searchResults = data; 
                const dropdown = document.getElementById('recordDropdown');
                dropdown.innerHTML = "";
                matches.forEach(key => {
                    const rec = data[key];
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.textContent = `${rec.date} | ${rec.customer} | ‚Çπ${rec.total}`;
                    dropdown.appendChild(opt);
                });
                document.getElementById('modalOverlay').style.display = 'block';
                document.getElementById('searchModal').style.display = 'block';
            }
        } catch (e) {
            alert("Connection error.");
        }
    }

    function confirmSelection() {
        const selectedKey = document.getElementById('recordDropdown').value;
        loadRecordIntoForm(searchResults[selectedKey]);
        closeModal();
    }

    function closeModal() {
        document.getElementById('modalOverlay').style.display = 'none';
        document.getElementById('searchModal').style.display = 'none';
    }

    function loadRecordIntoForm(record) {
        document.getElementById('custName').value = record.customer || "";
        document.getElementById('custPhone').value = record.phone || "";
        document.getElementById('dateInput').value = record.date || "";
        document.getElementById('salesExec').value = record.salesExec || "";
        document.getElementById('remarks').value = record.remarks || "";

        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = ""; 
        
        if (record.items && record.items.length > 0) {
            record.items.forEach(item => {
                const tr = addNewRow();
                tr.querySelector('.barcode').value = item.barcode || "";
                tr.querySelector('.desc').value = item.desc || "";
                tr.querySelector('.qty').value = item.qty || 1;
                tr.querySelector('.mrp').value = item.mrp || 0;
                tr.querySelector('.price').value = item.price || 0;
                
                if (item.image) {
                    const imgBox = tr.querySelector('.image-box');
                    imgBox.querySelectorAll('.upload-icon, .upload-text').forEach(el => el.remove());
                    const img = document.createElement('img');
                    img.src = item.image;
                    img.className = 'preview-image';
                    imgBox.prepend(img);
                }
                
                runCalc(tr.querySelector('.qty'));
            });
        }
    }

    function exportWithFileName() {
        const customerName = document.getElementById('custName').value.trim();
        const date = document.getElementById('dateInput').value;
        const originalTitle = document.title;
        document.title = customerName ? `Quotation - ${customerName} - ${date}` : `Quotation - Urban Casa - ${date}`;
        window.print();
        setTimeout(() => { document.title = originalTitle; }, 100);
    }
</script>
</body>
</html>
